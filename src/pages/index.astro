---
import { getCollection, type CollectionEntry } from "astro:content";
import {Content as Frontpage} from "../fragments/frontpage.mdx";
import { Code } from "astro-expressive-code/components";

import Layout from "../layouts/Layout.astro";
import Details from "../components/Details.astro";
import ProjectCard from "../components/ProjectCard.astro";

import { formatDate } from "../utils/date";

import pgpKey from "../../public/pgp.txt?raw";

const projects = (await getCollection(
	"projects",
)) as CollectionEntry<"projects">[];

// Sort projects so hidden ones come first
projects.sort((a, b) => {
	if (a.data.hidden && !b.data.hidden) return -1;
	if (!a.data.hidden && b.data.hidden) return 1;
	return a.data.title.localeCompare(b.data.title);
});

const posts = (await getCollection("blog")) as CollectionEntry<"blog">[];

const latestPosts = posts
	.sort(
		(a, b) =>
			new Date(b.data.date).getTime() - new Date(a.data.date).getTime(),
	)
	.slice(0, 3)
	.map((post) => ({
		...post,
		data: {
			...post.data,
			date: formatDate(post.data.date),
		},
	}));
---

<Layout title="Home" hideTitle>
	<h1 class="page-header">Hey, I'm <span class="hero-name">Joe</span></h1>

	<Frontpage />

	<Details summary="PGP Key" emoji={"\u{1F511}"}>
		<p>
			You can fetch the below key from <a href="/pgp.txt"
				><code>https://jb3.dev/pgp.txt</code></a
			> or copy the below public key block into your PGP client of choice.
		</p>
		<Code code={pgpKey} />
	</Details>

	<h2>Latest Blog Posts</h2>

	<ul class="recentPosts">
		{
			latestPosts.map((post) => (
				<li>
					<span>
						<a href={`/posts/${post.slug}/`}>{post.data.title}</a>{" "}
						<span class="post-rest">{post.data.date}</span>
					</span>
				</li>
			))
		}

		<li>
			<br />
			<a href="/posts/">View all posts</a>
		</li>
	</ul>

	<h2>Projects</h2>

	<div class="projectsHolder">
		{
			projects.map((project: any) => (
				<div
					data-nosnippet={project.data.hidden ? "true" : null}
					class:list={[
						"project-wrapper",
						{ "hidden-project": project.data.hidden },
					]}
				>
					<ProjectCard project={project} />
				</div>
			))
		}
	</div>
</Layout>

<style>
	.hero-name {
		animation: nameAnimation 5s infinite;
	}

	@keyframes nameAnimation {
		0% {
			color: #ec6f6f;
		}

		25% {
			color: #c596db;
		}

		50% {
			color: #84ad5e;
		}

		75% {
			color: #7ddce9;
		}

		100% {
			color: #ec6f6f;
		}
	}

	.projectsHolder {
		display: grid;
		gap: 20px;
		grid-template-columns: repeat(
			auto-fit,
			minmax(min(100%/1, max(300px, 100%/3)), 1fr)
		);
		grid-auto-rows: 1fr;
	}

	.project-wrapper {
		transition:
			transform 0.4s ease,
			opacity 0.4s ease;
	}

	.hidden-project {
		display: none;
		opacity: 0;
		transform: scale(0.8);
	}

	:global(.easter-egg-active) .hidden-project {
		display: block;
	}

	:global(.easter-egg-active) .hidden-project :global(.innerCard) {
		border-color: oklch(0.7 0.15 var(--hue));
		animation: rainbowHue 4s linear infinite;
	}

	:global(.easter-egg-active) .hidden-project :global(.innerCard) :global(h2),
	:global(.easter-egg-active) .hidden-project :global(.innerCard) :global(p) {
		color: oklch(0.7 0.15 var(--hue));
		animation: rainbowHue 4s linear infinite;
	}

	@property --hue {
		syntax: "<number>";
		initial-value: 0;
		inherits: true;
	}

	@keyframes rainbowHue {
		0% {
			--hue: 0;
		}
		100% {
			--hue: 360;
		}
	}

	.recentPosts {
		list-style-type: none;
		padding: 0;
	}

	.recentPosts li {
		margin-bottom: 10px;
	}

	.post-rest {
		color: var(--dimmed);
		font-style: italic;
	}
</style>

<script>
	import "../scripts/memberCount";
	import "../scripts/konamiCode";
</script>
